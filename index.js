"use strict";var __awaiter=this&&this.__awaiter||function(e,o,a,c){return new(a=a||Promise)(function(s,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?s(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(n,r)}i((c=c.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var i,o,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(s){return function(e){var t=[s,e];if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,o=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3]))c.label=t[1];else if(6===t[0]&&c.label<a[1])c.label=a[1],a=t;else{if(!(a&&c.label<a[2])){a[2]&&c.ops.pop(),c.trys.pop();continue}c.label=a[2],c.ops.push(t)}}t=r.call(n,c)}catch(e){t=[6,e],o=0}finally{i=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},WA=(Object.defineProperty(exports,"__esModule",{value:!0}),require("@adiwajshing/baileys")),pino_1=require("pino"),events_1=require("events"),chalk_1=require("chalk"),ws_1=require("ws"),mongodb_1=require("mongodb"),settings_1=require("./settings"),crypto=require("crypto"),sqlite3=require("sqlite3"),fs_1=require("fs"),decodeObject=function(e){return Object.fromEntries(Object.entries(e).map(function(e){var t=e[0],e=e[1];return"Buffer"===e.type?[t,Buffer.from(e.data)]:[t,"object"!=typeof e||Array.isArray(e)?e:decodeObject(e)]}))},promiseHelper=function(t){for(var s=[],e=1;e<arguments.length;e++)s[e-1]=arguments[e];return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,t.apply(void 0,s).then(function(e){return{res:e,error:void 0}}).catch(function(e){return console.error(e),{res:void 0,error:{message:e.message,name:e.name,stack:e.stack}}})];case 1:return[2,e.sent()]}})})},makeWASocket=WA.default,stringify=function(e){return JSON.stringify(e,WA.BufferJSON.replacer)},parse=function(e){return JSON.parse(e,WA.BufferJSON.reviver)},WSSSocket=function(){function e(e,t){this.retries=1,this.ev=new events_1.EventEmitter,this.MAX_RETRIES=1/0,this.connect=this.connect.bind(this),this.on=this.ev.on.bind(this.ev),this.off=this.ev.off.bind(this.ev),this.once=this.ev.once.bind(this.ev),this.address=e,this.options=t}return Object.defineProperty(e.prototype,"readyState",{get:function(){var e;return(null==(e=this.wss)?void 0:e.readyState)||ws_1.WebSocket.CLOSED},enumerable:!1,configurable:!0}),e.prototype.connect=function(){var s=this;this.wss&&this.wss.readyState!==ws_1.WebSocket.CLOSED||(console.log("".concat((0,chalk_1.green)("[WEBSOCKET]")," Connecting to [").concat(this.address,"]")),this.wss=new ws_1.WebSocket(this.address,this.options),this.wss.on("close",function(e,t){console.error("".concat((0,chalk_1.red)("[WEBSOCKET]")," Closed with code ").concat(e," ").concat(t)),s._onClose()}),this.wss.on("error",function(e){console.error((0,chalk_1.red)("[WEBSOCKET]"),e.stack)}),this.wss.on("open",function(){console.log("".concat((0,chalk_1.green)("[WEBSOCKET]")," Open.")),s.retries=1,s.ev.emit("open")}),this.wss.on("message",function(e,t){s.ev.emit("message",e,t)}),this.wss.on("ping",function(e){s.ev.emit("ping",e)}),this.wss.on("pong",function(e){s.ev.emit("pong",e)}))},e.prototype.waitForSession=function(){var e=this;return new Promise(function(t){if(e.session)return t(e.session);e.wss.once("message",function(e){e=JSON.parse(e.toString());if("info"!==e.iq)throw new Error("First message iq mismatch");t(e.name)})})},e.prototype._onClose=function(){if(this.wss.readyState!==ws_1.WebSocket.CLOSED&&this.wss.terminate(),this.retries<=this.MAX_RETRIES){var e=60;switch(!0){case this.retries<=3:e=5;break;case this.retries<=5:e=10;break;case this.retries<=7:e=15;break;case this.retries<=10:e=30}console.error("".concat((0,chalk_1.yellow)("[WEBSOCKET]")," Trying to reconnect in ").concat(e," seconds, retry ").concat(this.retries,"/").concat(this.MAX_RETRIES)),this.retries++,setTimeout(this.connect,1e3*e)}else console.error("".concat((0,chalk_1.red)("[WEBSOCKET]")," Closing.")),process.exit()},e.prototype.send=function(e){this.readyState!==ws_1.WebSocket.OPEN?console.error("".concat((0,chalk_1.yellow)("[WEBSOCKET]")," Error: WebSocket is not open: readyState ").concat(this.readyState)):this.wss.send(JSON.stringify(e))},e}(),WASocket=function(){function e(e){var t=this;this._createSock=this._createSock.bind(this),this.sendMessage=this.sendMessage.bind(this),Object.defineProperty(this,"msgRetryCountMap",{enumerable:!1,value:{}}),Object.defineProperty(this,"participantsCache",{enumerable:!1,value:new Map}),this.session=e.name,this.wss=e.wss,this.db=new WAAuth({session:this.session,database:"tamasocket",url:e.mongo,mode:settings_1.dbmode}),this.wss.on("message",function(e){t.wssHandler(JSON.parse(e.toString()))}),this.wss.on("open",function(){var e;t.socket.user&&(e=WA.jidDecode(t.socket.user.id),t.wss.send({iq:"user-data",id:e.user,jid:t.socket.user.id,name:t.socket.user.name,device:e.device})),t.wss.send({iq:"open",status:t.state})}),this._createSock(),setInterval(this.db.clean,6e4)}return e.prototype._createSock=function(){return __awaiter(this,void 0,void 0,function(){var i,u=this;return __generator(this,function(e){switch(e.label){case 0:if(this.socket&&"close"!==this.state)throw new Error("Socket state");return this.db.ready?[3,2]:[4,this.db.init()];case 1:e.sent(),e.label=2;case 2:return this.socket=makeWASocket({logger:(0,pino_1.default)({level:"silent"}),printQRInTerminal:!0,auth:{creds:this.db.creds,keys:this.db.keys},browser:["LN"].concat(WA.Browsers.baileys("Chrome").slice(1)),downloadHistory:!1,msgRetryCounterMap:this.msgRetryCountMap}),this.socket.ev.on("creds.update",this.db.saveCreds),this.db.bindEmmiter(this.socket.ev),this.socket.ev.on("connection.update",function(e){var t,s=e.connection,n=e.lastDisconnect,e=e.qr;switch(s){case"open":console.log("".concat((0,chalk_1.green)("[".concat(u.session,"]"))," Connection established"));break;case"close":var r=n.error;(null==(t=null==r?void 0:r.output)?void 0:t.statusCode)===WA.DisconnectReason.loggedOut?(u.socket.ev.removeAllListeners("connection.update"),console.log("".concat((0,chalk_1.yellow)("[".concat(u.session,"]"))," Logged out.")),u._postLogout()):(console.log("".concat((0,chalk_1.red)("[".concat(u.session,"]"))," Connection closed (").concat(r.message,")")),setTimeout(u._createSock,1e3));break;case"connecting":console.log("".concat((0,chalk_1.green)("[".concat(u.session,"]"))," Connecting..."))}e&&console.log("[".concat((0,chalk_1.green)(u.session),"] QR-Code received.")),s&&(u.state=s,u.wss.send({iq:"status",status:s})),u.socket.user&&(e=WA.jidDecode(u.socket.user.id),u.wss.send({iq:"user-data",id:e.user,jid:u.socket.user.id,name:u.socket.user.name,device:e.device}))}),i=crypto.scryptSync(settings_1.cookie,"salt",32),this.socket.ev.on("messages.upsert",function(r){return __awaiter(u,void 0,void 0,function(){var t,s,n;return __generator(this,function(e){return n=r.messages[0],"notify"===r.type&&n.message&&(n.message.ephemeralMessage&&(n.message=n.message.ephemeralMessage.message),t=crypto.randomBytes(16),s=crypto.createCipheriv("aes-256-cbc",i,t),n=s.update(JSON.stringify(n),"utf-8","hex")+s.final("hex"),this.wss.send({iq:"message",data:n,vector:t.toString("hex")})),[2]})})}),this.socket.ev.on("group-participants.update",function(e){var t=e.id,s=e.participants,n=e.action,r=(u.wss.send({iq:"group-participants-update",action:e.action,participants:e.participants,id:e.id}),u.participantsCache.get(t));if(r)switch(n){case"add":for(var i=0,o=s;i<o.length;i++)!function(t){r.some(function(e){return e.id===t})||r.push({id:t})}(o[i]);break;case"remove":for(var a=0,c=s;a<c.length;a++)!function(t){var e=r.findIndex(function(e){return e.id===t});-1!==e&&r.splice(e,1)}(c[a])}}),this.socket.ev.on("groups.update",function(e){u.wss.send({iq:"group-metadata-update",updates:e})}),[2]}})})},e.prototype._postLogout=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.db.delete()];case 1:return e.sent(),this.participantsCache.clear(),setTimeout(this._createSock,1e3),[2]}})})},e.prototype.sendMessage=function(n,r,i){return __awaiter(this,void 0,void 0,function(){var t,s=this;return __generator(this,function(e){switch(e.label){case 0:if(i=i||{},r=decodeObject(r),!WA.isJidGroup(n))return[3,5];if(this.participantsCache.has(n))return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.socket.groupMetadata(n)];case 2:return t=e.sent(),this.participantsCache.set(n,t.participants),[3,4];case 3:return t=e.sent(),console.error("Error in cached participants:",t),[3,4];case 4:i.cachedGroupMetadata=function(t){return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){return[2,{participants:this.participantsCache.get(t)}]})})},e.label=5;case 5:return[4,this.socket.sendMessage(n,r,i)];case 6:return[2,e.sent()]}})})},e.prototype.wssHandler=function(l){return __awaiter(this,void 0,void 0,function(){var t,s,n,r,i,o,a,c,u,d,h;return __generator(this,function(e){switch(e.label){case 0:switch(l.iq){case"get-status":return[3,1];case"log":return[3,3];case"send-message":return[3,4];case"send-read":return[3,6];case"group-metadata":return[3,8];case"participants-update":return[3,10];case"get-groups":return[3,12]}return[3,14];case 1:return c=l.wsid,[4,this.db.getStats()];case 2:return r=e.sent(),t=r.objects,s=r.dataSize,n=r.avgObjSize,r=r.indexSize,this.wss.send({iq:"status-response",wsid:c,data:{mem:process.memoryUsage(),objects:t,dataSize:s,avgObjSize:n,indexSize:r},error:void 0}),[3,14];case 3:return t=l.data,console.log(t),[3,14];case 4:return o=l.id,s=l.content,n=l.options,c=l.wsid,[4,promiseHelper(this.sendMessage,o,s,n)];case 5:return r=e.sent(),d=r.res,h=r.error,this.wss.send({iq:"message-response",wsid:c,data:d,error:h}),[3,14];case 6:return c=l.wsid,i=l.keys,[4,promiseHelper(this.socket.readMessages,i)];case 7:return h=e.sent().error,this.wss.send({iq:"read-response",wsid:c,error:h}),[3,14];case 8:return c=l.wsid,o=l.id,[4,promiseHelper(this.socket.groupMetadata,o)];case 9:return i=e.sent(),d=i.res,h=i.error,this.wss.send({iq:"metadata-response",wsid:c,data:d,error:h}),[3,14];case 10:return c=l.wsid,o=l.id,a=l.users,u=l.action,[4,promiseHelper(this.socket.groupParticipantsUpdate,o,a,u)];case 11:return a=e.sent(),d=a.res,h=a.error,this.wss.send({iq:"participants-update-response",wsid:c,data:d,error:h}),[3,14];case 12:return c=l.wsid,[4,promiseHelper(this.socket.groupFetchAllParticipating)];case 13:return u=e.sent(),d=u.res,h=u.error,this.wss.send({iq:"groups-response",wsid:c,data:d,error:h}),[3,14];case 14:return[2]}})})},e}(),WAAuth=function(){function e(e){if(this.ready=!1,this.keys={get:null,set:null},this.clean=this.clean.bind(this),Object.defineProperties(this,{keysMap:{value:new Map,enumerable:!1},messagesMap:{value:new Map,enumerable:!1},mode:{get:function(){return e.mode}}}),this.nameDb=e.database,this.session=e.session,"mongodb"===this.mode&&(this.mongo=new mongodb_1.MongoClient(e.url)),"mongodb"!==this.mode&&"sqlite"!==this.mode)throw new Error("Invalid database mode: ".concat(this.mode))}return e.prototype.init=function(){return"mongodb"===this.mode?this._initMongodb():"sqlite"===this.mode?this._initSqlite():void 0},e.prototype._initSqlite=function(){return __awaiter(this,void 0,void 0,function(){var l,h,t,p,r=this;return __generator(this,function(e){switch(e.label){case 0:if(this.ready)throw new Error("Already initialized.");return this.sql=new sqlite3.Database(this.nameDb),l=function(e,t){return new Promise(function(s,n){return r.sql.run(e,t,function(e,t){e?n(e):s(t)})})},h=function(e,t){return new Promise(function(s,n){return r.sql.get(e,t,function(e,t){e?n(e):s(t)})})},[4,(0,events_1.once)(this.sql,"open")];case 1:return e.sent(),[4,l("CREATE TABLE IF NOT EXISTS auth (type text, id text, data text);")];case 2:return e.sent(),[4,h("SELECT * FROM auth WHERE type=($type) AND id=($id)",{$id:"1",$type:"creds"})];case 3:return t=e.sent(),Object.defineProperty(this,"creds",{enumerable:!1,writable:!0,value:t?parse(t.data):WA.initAuthCreds()}),t?[3,5]:[4,l("INSERT INTO auth VALUES (?, ?, ?)",["creds","1",stringify(this.creds)])];case 4:e.sent(),e.label=5;case 5:return p={get:function(e){var t=e.type,e=e.id,t=r.keysMap.get("".concat(t,"_").concat(e));return t&&(t.ts=Date.now()),t},set:function(e){e.ts=Date.now(),r.keysMap.set("".concat(e.type,"_").concat(e.id),e)},has:function(e){var t=e.type,e=e.id;return r.keysMap.has("".concat(t,"_").concat(e))},delete:function(e){var t=e.type,e=e.id;return r.keysMap.delete("".concat(t,"_").concat(e))}},this.saveCreds=function(){return __awaiter(r,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,l("REPLACE INTO auth VALUES (?, ?, ?)",["creds","1",stringify(this.creds)])];case 1:return e.sent(),[2]}})})},this.keys.get=function(u,d){return __awaiter(r,void 0,void 0,function(){var t,s,n,r,i,o,a,c;return __generator(this,function(e){switch(e.label){case 0:if(t={},!(n=d.filter(function(e){return!p.has({type:u,id:e})})).length)return[3,4];s=0,n=n,e.label=1;case 1:return s<n.length?(o=n[s],[4,h("SELECT * FROM auth WHERE type=($t) AND id=($id)",{$id:o,$t:u})]):[3,4];case 2:if(null==(a=e.sent())||!a.data)return[3,3];p.set(a),e.label=3;case 3:return s++,[3,1];case 4:for(r=0,i=d;r<i.length;r++)o=i[r],(a=p.get({type:u,id:o}))?(c=parse(a.data),"app-state-sync-key"===u&&(c=WA.WAProto.Message.AppStateSyncKeyData.fromObject(c)),t[o]=c):t[o]=null;return[2,t]}})})},this.keys.set=function(h){return __awaiter(r,void 0,void 0,function(){var n,t,s,r,i,o,a,c,u,d;return __generator(this,function(e){switch(e.label){case 0:for(s in n=this.sql.prepare("INSERT OR REPLACE INTO auth VALUES (?, ?, ?)"),t=[],h)t.push(s);r=0,e.label=1;case 1:if(!(r<t.length))return[3,7];for(a in i=t[r],o=[],h[i])o.push(a);c=0,e.label=2;case 2:return c<o.length?(u=o[c],(d=h[i][u])?(d=stringify(d),n.run(i,u,d),p.set({id:u,type:i,data:d}),[3,5]):[3,3]):[3,6];case 3:return[4,l("DELETE FROM auth WHERE type=$t AND id=$i",{$t:i,$i:u})];case 4:e.sent(),p.delete({type:i,id:u}),e.label=5;case 5:return c++,[3,2];case 6:return r++,[3,1];case 7:return[4,new Promise(function(t,s){return n.finalize(function(e){return e?s(e):t()})})];case 8:return e.sent(),[2]}})})},this.ready=!0,[2]}})})},e.prototype._initMongodb=function(){return __awaiter(this,void 0,void 0,function(){var t,l,s=this;return __generator(this,function(e){switch(e.label){case 0:if(this.ready)throw new Error("Already initialized.");return[4,this.mongo.connect()];case 1:return e.sent(),this.db=this.mongo.db(this.nameDb),this.authColl=this.db.collection("auth-".concat(this.session)),this.storeColl=this.db.collection("store-".concat(this.session)),this.authColl.createIndex({type:1,id:1},{unique:!0}),this.storeColl.createIndex({messageId:1},{unique:!0}),[4,this.authColl.findOne({type:"creds",id:"creds"})];case 2:return t=e.sent(),Object.defineProperty(this,"creds",{enumerable:!1,writable:!0,value:t?parse(t.data):WA.initAuthCreds()}),l={get:function(e){var t=e.type,e=e.id,t=s.keysMap.get("".concat(t,"_").concat(e));return t&&(t.ts=Date.now()),t},set:function(e){e.ts=Date.now(),s.keysMap.set("".concat(e.type,"_").concat(e.id),e)},has:function(e){var t=e.type,e=e.id;return s.keysMap.has("".concat(t,"_").concat(e))},delete:function(e){var t=e.type,e=e.id;return s.keysMap.delete("".concat(t,"_").concat(e))}},this.saveCreds=function(){return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.authColl.updateOne({type:"creds",id:"creds"},{$set:{data:stringify(this.creds)}},{upsert:!0})];case 1:return e.sent(),[2]}})})},this.keys.get=function(d,h){return __awaiter(s,void 0,void 0,function(){var t,s,n,r,i,o,a,c,u;return __generator(this,function(e){switch(e.label){case 0:return(t={},(s=h.filter(function(e){return!l.has({type:d,id:e})})).length)?[4,this.authColl.find({type:d,id:{$in:s}}).toArray()]:[3,2];case 1:for(s=e.sent(),n=0,r=s;n<r.length;n++)c=r[n],l.set(c);e.label=2;case 2:for(i=0,o=h;i<o.length;i++)a=o[i],(c=l.get({type:d,id:a}))?(u=parse(c.data),"app-state-sync-key"===d&&(u=WA.WAProto.Message.AppStateSyncKeyData.fromObject(u)),t[a]=u):t[a]=null;return[2,t]}})})},this.keys.set=function(i){return __awaiter(s,void 0,void 0,function(){var t,s,n,r;return __generator(this,function(e){for(s in t=[],i)for(n in i[s])(r=i[s][n])?(r=stringify(r),t.push({updateOne:{filter:{id:n,type:s},update:{$set:{data:r}},upsert:!0}}),l.set({id:n,type:s,data:r})):(t.push({deleteOne:{filter:{id:n,type:s}}}),l.delete({type:s,id:n}));return this.authColl.bulkWrite(t),[2]})})},this.ready=!0,[2]}})})},e.prototype.getStats=function(){return this.db.stats()},e.prototype.delete=function(){return __awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(e){switch(e.label){case 0:return(this.ready=!1,this.messagesMap.clear(),this.keysMap.clear(),this.creds=void 0,"mongodb"!==this.mode)?[3,3]:(Object.defineProperty(this,"creds",{enumerable:!1,value:WA.initAuthCreds()}),[4,this.authColl.deleteMany({})]);case 1:return e.sent(),[4,this.storeColl.deleteMany({})];case 2:return e.sent(),this.ready=!0,[3,6];case 3:return"sqlite"!==this.mode?[3,6]:[4,new Promise(function(t,s){return n.sql.close(function(e){return e?s(e):t()})})];case 4:return e.sent(),(0,fs_1.unlinkSync)(this.nameDb),[4,this._initSqlite()];case 5:e.sent(),e.label=6;case 6:return[2]}})})},e.prototype.clean=function(){var s=this;this.messagesMap.forEach(function(e,t){e=e.createdAt;6e4<Date.now()-e&&s.messagesMap.delete(t)}),this.keysMap.forEach(function(e,t){e=e.ts;6e5<Date.now()-e&&s.keysMap.delete(t)})},e.prototype.bindEmmiter=function(e){var s=this;e.on("messages.upsert",function(e){var t=e.messages;"notify"===e.type&&"status@broadcast"!==(e=t[0]).key.remoteJid&&e.messageStubType!==WA.WAMessageStubType.CIPHERTEXT&&e.message&&(t=e.key.id,e={messageId:e.key.id,message:e,timestamp:Number(e.messageTimestamp),createdAt:Date.now(),deleted:!1},s.messagesMap.set(t,e))})},e.prototype.getMessage=function(s){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return(t=this.messagesMap.get(s))?[2,t.message]:[4,this.storeColl.findOne({messageId:s})];case 1:return(t=e.sent())&&delete t._id,[2,t.message]}})})},e}(),main=function(){return __awaiter(void 0,void 0,void 0,function(){var t,s;return __generator(this,function(e){switch(e.label){case 0:return console.info=function(){},console.warn=function(){},(t=new WSSSocket("wss://konekotoujou.com:7474",{headers:{cookie:settings_1.cookie}})).connect(),[4,(0,events_1.once)(t,"open")];case 1:return e.sent(),[4,t.waitForSession()];case 2:return s=e.sent(),t.send({iq:"open",status:"close"}),new WASocket({mongo:settings_1.mongo,name:s,wss:t}),[2]}})})};main();